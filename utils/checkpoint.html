<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Checkpoint utils – physmodjax</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Checkpoint utils – physmodjax">
<meta property="og:description" content="Physical modelling using neural networks with JAX">
<meta property="og:site_name" content="physmodjax">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">physmodjax</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rodrigodzf/physmodjax"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../utils/checkpoint.html">Utils</a></li><li class="breadcrumb-item"><a href="../utils/checkpoint.html">Checkpoint utils</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Install</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../results.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Results</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/autoencoders.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Autoencoder models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/conv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Convolutional models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/fno.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fourier Neural Operator in 1D and 2D</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/fno_rnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">FNO embedded in a recurrent neural network</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/mlp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLP models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/recurrent.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Recurrent Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../models/ssm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SSM Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Scripts</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scripts/dataset_generation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dataset generation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scripts/train_rnn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Training an RNN</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Solver</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/impulse_generator.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Impulse generator</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave1d_solver_fe.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Finite element solver for the 1D wave equation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave1d_solver_modal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modal Solver</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave1d_solver_pseudospectral.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pseudo-spectral Solver</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave1d_solver_tensionmodulated.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tension modulated string</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave2d_solver_modal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wave 2D linear solver</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../solver/wave2d_solver_tensionmodulated.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tension modulated stiff membrane</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Utils</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/checkpoint.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Checkpoint utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dataloading utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/ftm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Funtional Transformation Method Utilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/linear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Linear utility functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/losses.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Losses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metrics and losses</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/modal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modal utils</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../utils/plot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plotting utilities</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#restore_experiment_state" id="toc-restore_experiment_state" class="nav-link active" data-scroll-target="#restore_experiment_state">restore_experiment_state</a></li>
  <li><a href="#returns" id="toc-returns" class="nav-link" data-scroll-target="#returns">Returns:</a>
  <ul class="collapse">
  <li><a href="#download_ckpt_single_run" id="toc-download_ckpt_single_run" class="nav-link" data-scroll-target="#download_ckpt_single_run">download_ckpt_single_run</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/rodrigodzf/physmodjax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../utils/checkpoint.html">Utils</a></li><li class="breadcrumb-item"><a href="../utils/checkpoint.html">Checkpoint utils</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Checkpoint utils</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<pre><code>/opt/hostedtoolcache/Python/3.10.14/x64/lib/python3.10/site-packages/fastcore/docscrape.py:230: UserWarning: potentially wrong underline length... 
Returns: 
------- in 
Restores the train state from a run.
...
  else: warn(msg)</code></pre>
<hr>
<p><a href="https://github.com/rodrigodzf/physmodjax/blob/main/physmodjax/utils/checkpoint.py#L20" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="restore_experiment_state" class="level3">
<h3 class="anchored" data-anchor-id="restore_experiment_state">restore_experiment_state</h3>
<blockquote class="blockquote">
<pre><code> restore_experiment_state (run_path:pathlib.Path, best:bool=True,
                           step_to_restore:int=None,
                           x0_shape:Tuple[int]=(1, 101, 1),
                           x_shape:Tuple[int]=(1, 1, 101, 1),
                           kwargs:dict={})</code></pre>
</blockquote>
<p>*Restores the train state from a run.</p>
<p>Args: run_path (Path): Path to the run directory (e.g.&nbsp;“outputs/2024-01-23/22-15-11”)</p>
</section>
<section id="returns" class="level2">
<h2 class="anchored" data-anchor-id="returns">Returns:</h2>
<pre><code>train_state.TrainState: The train state of the experiment
nn.Module: The model used in the experiment
CheckpointManager: The checkpoint manager*</code></pre>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>run_path</td>
<td>Path</td>
<td></td>
<td>Path to the run directory (e.g.&nbsp;“outputs/2024-01-23/22-15-11”)</td>
</tr>
<tr class="even">
<td>best</td>
<td>bool</td>
<td>True</td>
<td>If True, restore the best checkpoint instead of the latest</td>
</tr>
<tr class="odd">
<td>step_to_restore</td>
<td>int</td>
<td>None</td>
<td>If not None, restore the checkpoint at this step</td>
</tr>
<tr class="even">
<td>x0_shape</td>
<td>Tuple</td>
<td>(1, 101, 1)</td>
<td>Shape of the initial condition</td>
</tr>
<tr class="odd">
<td>x_shape</td>
<td>Tuple</td>
<td>(1, 1, 101, 1)</td>
<td>Shape of the input data</td>
</tr>
<tr class="even">
<td>kwargs</td>
<td>dict</td>
<td>{}</td>
<td>Additional arguments to pass to the model</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>Tuple</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<p><a href="https://github.com/rodrigodzf/physmodjax/blob/main/physmodjax/utils/checkpoint.py#L102" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="download_ckpt_single_run" class="level3">
<h3 class="anchored" data-anchor-id="download_ckpt_single_run">download_ckpt_single_run</h3>
<blockquote class="blockquote">
<pre><code> download_ckpt_single_run (run_name:str, project:str,
                           tmp_dir:pathlib.Path=Path('/tmp/physmodjax'),
                           overwrite:bool=False)</code></pre>
</blockquote>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydra <span class="im">import</span> initialize, compose</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydra.core.hydra_config <span class="im">import</span> HydraConfig</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> physmodjax.scripts.train_rnn <span class="im">import</span> train_rnn</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>data_array <span class="op">=</span> <span class="st">"../data/ftm_string_nonlin_1000_Noise_4000Hz_1.0s.npy"</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>split <span class="op">=</span> [<span class="fl">0.01</span>, <span class="fl">0.01</span>, <span class="fl">0.01</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>extract_channels <span class="op">=</span> [<span class="dv">0</span>]</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">""</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> initialize(version_base<span class="op">=</span><span class="va">None</span>, config_path<span class="op">=</span><span class="st">"../../conf"</span>):</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    cfg <span class="op">=</span> compose(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        return_hydra_config<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        config_name<span class="op">=</span><span class="st">"train_rnn"</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        overrides<span class="op">=</span>[</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"+experiment=1d_koopman"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"++datamodule.data_array=</span><span class="sc">{</span>data_array<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"++datamodule.batch_size=</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"++datamodule.split=</span><span class="sc">{</span>split<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"++datamodule.extract_channels=</span><span class="sc">{</span>extract_channels<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"++model.d_vars=1"</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"++epochs=1"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"++epochs_val=1"</span>,</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"++wandb.project=physmodjax"</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"++wandb.entity=iir-modal"</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    OmegaConf.register_new_resolver(<span class="st">"eval"</span>, <span class="bu">eval</span>, replace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    OmegaConf.resolve(cfg)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    cfg_no_hydra <span class="op">=</span> {k:v <span class="cf">for</span> (k,v) <span class="kw">in</span> cfg.items() <span class="cf">if</span> <span class="st">"hydra"</span> <span class="kw">not</span> <span class="kw">in</span> k} </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(OmegaConf.to_yaml(cfg_no_hydra))</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    HydraConfig.instance().set_config(cfg)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(OmegaConf.to_yaml((HydraConfig.get().runtime)))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    output_dir <span class="op">=</span> Path(cfg.hydra.run.<span class="bu">dir</span>).absolute()</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HydraConfig.get().runtime["output_dir"] = output_dir</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    HydraConfig.instance().set_config(cfg)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Output dir: </span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    train_rnn(cfg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>wandb: WARNING Path /Users/diaz/projects/physmodjax/nbs/utils/outputs/2024-09-03/12-28-33/wandb/ wasn't writable, using system temp directory.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>model:
  _target_: physmodjax.models.autoencoders.BatchedKoopmanAutoencoder1D
  _partial_: true
  d_vars: 1
  d_model: 101
  norm: layer
  encoder_model:
    _target_: physmodjax.models.mlp.MLP
    _partial_: true
    hidden_channels:
    - 128
    - 128
    - 256
    kernel_init:
      _target_: flax.linen.initializers.orthogonal
  decoder_model:
    _target_: physmodjax.models.mlp.MLP
    _partial_: true
    hidden_channels:
    - 128
    - 128
    - 101
    kernel_init:
      _target_: flax.linen.initializers.orthogonal
  dynamics_model:
    _target_: physmodjax.models.recurrent.LRUDynamics
    _partial_: true
    d_hidden: 128
    r_min: 0.99
    r_max: 0.999
    max_phase: 6.28
    clip_eigs: true
datamodule:
  _target_: physmodjax.utils.data.DirectoryDataModule
  split:
  - 0.01
  - 0.01
  - 0.01
  batch_size: 1
  extract_channels:
  - 0
  total_num_train: 4000
  total_num_val: 4000
  total_num_test: 4000
  num_steps_train:
  - 1
  - 3999
  num_steps_val:
  - 1
  - 3999
  mode: split
  standardize_dataset: true
  windowed: false
  cache: true
  data_array: ../data/ftm_string_nonlin_1000_Noise_4000Hz_1.0s.npy
jax:
  platform_name: null
  preallocate_gpu_memory: false
optimiser:
  _target_: optax.adamw
  learning_rate: 0.0001
gradient_clip:
  _target_: optax.clip_by_global_norm
  max_norm: 1.0
loss:
  _target_: physmodjax.utils.losses.lindyn_loss
  _partial_: true
  encdec_weight: 1.0
  lindyn_weight: 0.01
  pred_weight: 1.0
seed: 3407
epochs: 1
epochs_val: 1
frozen: []
init_from_linear: false
schedule_type: constant
wandb:
  group: 1d
  project: physmodjax
  entity: iir-modal

version: 1.3.2
version_base: '1.3'
cwd: /Users/diaz/projects/physmodjax/nbs/utils
config_sources:
- path: hydra.conf
  schema: pkg
  provider: hydra
- path: /Users/diaz/projects/physmodjax/conf
  schema: file
  provider: main
- path: ''
  schema: structured
  provider: schema
output_dir: ???
choices:
  experiment: 1d_koopman
  loss: lindyn
  gradient_clip: default.yaml
  optimiser: default.yaml
  jax: default.yaml
  datamodule: string
  model: 1d_koopman
  hydra/env: default
  hydra/callbacks: null
  hydra/job_logging: default
  hydra/hydra_logging: default
  hydra/hydra_help: default
  hydra/help: default
  hydra/sweeper: basic
  hydra/launcher: basic
  hydra/output: default

Output dir: /Users/diaz/projects/physmodjax/nbs/utils/outputs/2024-09-03/12-28-33</code></pre>
</div>
<div class="cell-output cell-output-display">
Finishing last run (ID:bg96gmb3) before initializing another...
</div>
<div class="cell-output cell-output-display">
 View run <strong style="color:#cdcd00">chocolate-dream-1762</strong> at: <a href="https://wandb.ai/iir-modal/physmodjax/runs/bg96gmb3" target="_blank">https://wandb.ai/iir-modal/physmodjax/runs/bg96gmb3</a><br> View project at: <a href="https://wandb.ai/iir-modal/physmodjax" target="_blank">https://wandb.ai/iir-modal/physmodjax</a><br>Synced 5 W&amp;B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)
</div>
<div class="cell-output cell-output-display">
Find logs at: <code>/var/folders/f_/jbsvj3wx2gv9z_2s7ywlc8p00000gn/T/wandb/run-20240903_120018-bg96gmb3/logs</code>
</div>
<div class="cell-output cell-output-display">
Successfully finished last run (ID:bg96gmb3). Initializing new run:<br>
</div>
<div class="cell-output cell-output-display">
Tracking run with wandb version 0.17.8
</div>
<div class="cell-output cell-output-display">
Run data is saved locally in <code>/var/folders/f_/jbsvj3wx2gv9z_2s7ywlc8p00000gn/T/wandb/run-20240903_122833-4z5togcj</code>
</div>
<div class="cell-output cell-output-display">
Syncing run <strong><a href="https://wandb.ai/iir-modal/physmodjax/runs/4z5togcj" target="_blank">serene-butterfly-1763</a></strong> to <a href="https://wandb.ai/iir-modal/physmodjax" target="_blank">Weights &amp; Biases</a> (<a href="https://wandb.me/run" target="_blank">docs</a>)<br>
</div>
<div class="cell-output cell-output-display">
 View project at <a href="https://wandb.ai/iir-modal/physmodjax" target="_blank">https://wandb.ai/iir-modal/physmodjax</a>
</div>
<div class="cell-output cell-output-display">
 View run at <a href="https://wandb.ai/iir-modal/physmodjax/runs/4z5togcj" target="_blank">https://wandb.ai/iir-modal/physmodjax/runs/4z5togcj</a>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AssertionError</span>                            Traceback (most recent call last)
File <span class="ansi-green-fg">~/mambaforge/envs/physmodjax/lib/python3.10/site-packages/hydra/_internal/instantiate/_instantiate2.py:92</span>, in <span class="ansi-cyan-fg">_call_target</span><span class="ansi-blue-fg">(_target_, _partial_, args, kwargs, full_key)</span>
<span class="ansi-green-fg ansi-bold">     91</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">---&gt; 92</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_target_</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     93</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:

File <span class="ansi-green-fg">~/projects/physmodjax/physmodjax/utils/data.py:407</span>, in <span class="ansi-cyan-fg">DirectoryDataModule.__init__</span><span class="ansi-blue-fg">(self, data_array, split, batch_size, extract_channels, num_steps_train, num_steps_val, standardize_dataset, mean, std, mode, windowed, hankelize, shuffle_train, cache, rolling_windows, total_num_train, total_num_val, total_num_test)</span>
<span class="ansi-green-fg ansi-bold">    405</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_batch_size <span style="color:rgb(98,98,98)">=</span> batch_size
<span class="ansi-green-fg">--&gt; 407</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> Path(data_array)<span style="color:rgb(98,98,98)">.</span>exists() <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">all</span>(
<span class="ansi-green-fg ansi-bold">    408</span>     [Path(d)<span style="color:rgb(98,98,98)">.</span>exists() <span style="font-weight:bold;color:rgb(0,135,0)">for</span> d <span style="font-weight:bold;color:rgb(175,0,255)">in</span> data_array]
<span class="ansi-green-fg ansi-bold">    409</span> ), <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">The data array does not exist</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    411</span> <span style="font-style:italic;color:rgb(95,135,135)"># if we have a list of directories, we will concatenate the data</span>
<span class="ansi-green-fg ansi-bold">    412</span> <span style="font-style:italic;color:rgb(95,135,135)"># else we will assume that the directory contains the data</span>

<span class="ansi-red-fg">AssertionError</span>: The data array does not exist

The above exception was the direct cause of the following exception:

<span class="ansi-red-fg">InstantiationException</span>                    Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[12], line 41</span>
<span class="ansi-green-fg ansi-bold">     37</span> HydraConfig<span style="color:rgb(98,98,98)">.</span>instance()<span style="color:rgb(98,98,98)">.</span>set_config(cfg)
<span class="ansi-green-fg ansi-bold">     39</span> <span style="color:rgb(0,135,0)">print</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Output dir: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>output_dir<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg">---&gt; 41</span> <span class="ansi-yellow-bg">train_rnn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">cfg</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/mambaforge/envs/physmodjax/lib/python3.10/site-packages/hydra/main.py:83</span>, in <span class="ansi-cyan-fg">main.&lt;locals&gt;.main_decorator.&lt;locals&gt;.decorated_main</span><span class="ansi-blue-fg">(cfg_passthrough)</span>
<span class="ansi-green-fg ansi-bold">     80</span> <span style="color:rgb(175,0,255)">@functools</span><span style="color:rgb(98,98,98)">.</span>wraps(task_function)
<span class="ansi-green-fg ansi-bold">     81</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span> <span style="color:rgb(0,0,255)">decorated_main</span>(cfg_passthrough: Optional[DictConfig] <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Any:
<span class="ansi-green-fg ansi-bold">     82</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> cfg_passthrough <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">---&gt; 83</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">task_function</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">cfg_passthrough</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     84</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">     85</span>         args_parser <span style="color:rgb(98,98,98)">=</span> get_args_parser()

File <span class="ansi-green-fg">~/projects/physmodjax/physmodjax/scripts/train_rnn.py:482</span>, in <span class="ansi-cyan-fg">train_rnn</span><span class="ansi-blue-fg">(cfg)</span>
<span class="ansi-green-fg ansi-bold">    471</span> run <span style="color:rgb(98,98,98)">=</span> wandb<span style="color:rgb(98,98,98)">.</span>init(
<span class="ansi-green-fg ansi-bold">    472</span>     <span style="color:rgb(0,135,0)">dir</span><span style="color:rgb(98,98,98)">=</span>output_dir,
<span class="ansi-green-fg ansi-bold">    473</span>     config<span style="color:rgb(98,98,98)">=</span>OmegaConf<span style="color:rgb(98,98,98)">.</span>to_container(
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    478</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>cfg<span style="color:rgb(98,98,98)">.</span>wandb,
<span class="ansi-green-fg ansi-bold">    479</span> )
<span class="ansi-green-fg ansi-bold">    481</span> model_cls <span style="color:rgb(98,98,98)">=</span> hydra<span style="color:rgb(98,98,98)">.</span>utils<span style="color:rgb(98,98,98)">.</span>instantiate(cfg<span style="color:rgb(98,98,98)">.</span>model)
<span class="ansi-green-fg">--&gt; 482</span> datamodule <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">hydra</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">utils</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">instantiate</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">cfg</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    484</span> <span style="font-style:italic;color:rgb(95,135,135)"># Log data info</span>
<span class="ansi-green-fg ansi-bold">    485</span> wandb<span style="color:rgb(98,98,98)">.</span>config<span style="color:rgb(98,98,98)">.</span>update({<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">output_dir</span><span style="color:rgb(175,0,0)">"</span>: output_dir})

File <span class="ansi-green-fg">~/mambaforge/envs/physmodjax/lib/python3.10/site-packages/hydra/_internal/instantiate/_instantiate2.py:226</span>, in <span class="ansi-cyan-fg">instantiate</span><span class="ansi-blue-fg">(config, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    223</span>     _convert_ <span style="color:rgb(98,98,98)">=</span> config<span style="color:rgb(98,98,98)">.</span>pop(_Keys<span style="color:rgb(98,98,98)">.</span>CONVERT, ConvertMode<span style="color:rgb(98,98,98)">.</span>NONE)
<span class="ansi-green-fg ansi-bold">    224</span>     _partial_ <span style="color:rgb(98,98,98)">=</span> config<span style="color:rgb(98,98,98)">.</span>pop(_Keys<span style="color:rgb(98,98,98)">.</span>PARTIAL, <span style="font-weight:bold;color:rgb(0,135,0)">False</span>)
<span class="ansi-green-fg">--&gt; 226</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">instantiate_node</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    227</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">config</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">recursive</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_recursive_</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">convert</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_convert_</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">partial</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">_partial_</span>
<span class="ansi-green-fg ansi-bold">    228</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    229</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> OmegaConf<span style="color:rgb(98,98,98)">.</span>is_list(config):
<span class="ansi-green-fg ansi-bold">    230</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Finalize config (convert targets to strings, merge with kwargs)</span>
<span class="ansi-green-fg ansi-bold">    231</span>     config_copy <span style="color:rgb(98,98,98)">=</span> copy<span style="color:rgb(98,98,98)">.</span>deepcopy(config)

File <span class="ansi-green-fg">~/mambaforge/envs/physmodjax/lib/python3.10/site-packages/hydra/_internal/instantiate/_instantiate2.py:347</span>, in <span class="ansi-cyan-fg">instantiate_node</span><span class="ansi-blue-fg">(node, convert, recursive, partial, *args)</span>
<span class="ansi-green-fg ansi-bold">    342</span>                 value <span style="color:rgb(98,98,98)">=</span> instantiate_node(
<span class="ansi-green-fg ansi-bold">    343</span>                     value, convert<span style="color:rgb(98,98,98)">=</span>convert, recursive<span style="color:rgb(98,98,98)">=</span>recursive
<span class="ansi-green-fg ansi-bold">    344</span>                 )
<span class="ansi-green-fg ansi-bold">    345</span>             kwargs[key] <span style="color:rgb(98,98,98)">=</span> _convert_node(value, convert)
<span class="ansi-green-fg">--&gt; 347</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_call_target</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">_target_</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">partial</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">full_key</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    348</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    349</span>     <span style="font-style:italic;color:rgb(95,135,135)"># If ALL or PARTIAL non structured or OBJECT non structured,</span>
<span class="ansi-green-fg ansi-bold">    350</span>     <span style="font-style:italic;color:rgb(95,135,135)"># instantiate in dict and resolve interpolations eagerly.</span>
<span class="ansi-green-fg ansi-bold">    351</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> convert <span style="color:rgb(98,98,98)">==</span> ConvertMode<span style="color:rgb(98,98,98)">.</span>ALL <span style="font-weight:bold;color:rgb(175,0,255)">or</span> (
<span class="ansi-green-fg ansi-bold">    352</span>         convert <span style="font-weight:bold;color:rgb(175,0,255)">in</span> (ConvertMode<span style="color:rgb(98,98,98)">.</span>PARTIAL, ConvertMode<span style="color:rgb(98,98,98)">.</span>OBJECT)
<span class="ansi-green-fg ansi-bold">    353</span>         <span style="font-weight:bold;color:rgb(175,0,255)">and</span> node<span style="color:rgb(98,98,98)">.</span>_metadata<span style="color:rgb(98,98,98)">.</span>object_type <span style="font-weight:bold;color:rgb(175,0,255)">in</span> (<span style="font-weight:bold;color:rgb(0,135,0)">None</span>, <span style="color:rgb(0,135,0)">dict</span>)
<span class="ansi-green-fg ansi-bold">    354</span>     ):

File <span class="ansi-green-fg">~/mambaforge/envs/physmodjax/lib/python3.10/site-packages/hydra/_internal/instantiate/_instantiate2.py:97</span>, in <span class="ansi-cyan-fg">_call_target</span><span class="ansi-blue-fg">(_target_, _partial_, args, kwargs, full_key)</span>
<span class="ansi-green-fg ansi-bold">     95</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> full_key:
<span class="ansi-green-fg ansi-bold">     96</span>     msg <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,0)">\n</span><span style="color:rgb(175,0,0)">full_key: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>full_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">---&gt; 97</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> InstantiationException(msg) <span style="font-weight:bold;color:rgb(0,135,0)">from</span> <span style="font-weight:bold;color:rgb(0,0,255)">e</span>

<span class="ansi-red-fg">InstantiationException</span>: Error in call to target 'physmodjax.utils.data.DirectoryDataModule':
AssertionError('The data array does not exist')
full_key: datamodule</pre>
</div>
</div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instantiate the datamodule</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>datamodule <span class="op">=</span> hydra.utils.instantiate(cfg.datamodule)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>train_dataloader <span class="op">=</span> datamodule.train_dataloader</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>val_dataloader <span class="op">=</span> datamodule.val_dataloader</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>test_dataloader <span class="op">=</span> datamodule.test_dataloader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>checkpoint_path, cfg <span class="op">=</span> download_ckpt_single_run(<span class="st">"eager-valley-1758"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>kwargs <span class="op">=</span> {<span class="st">"n_steps"</span>: datamodule.num_steps_target_val}</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>state, model, ckpt_manager <span class="op">=</span> restore_experiment_state(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    checkpoint_path,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    kwargs<span class="op">=</span>kwargs,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Checkpoint already exists at /tmp/physmodjax/checkpoints_fiug7qv5:v0, skipping
Using data_info from config: [1, 101, 1]
Restoring checkpoint from step 1...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/diaz/anaconda3/envs/physmodjax_private/lib/python3.10/site-packages/orbax/checkpoint/type_handlers.py:1552: UserWarning: Couldn't find sharding info under RestoreArgs. Populating sharding info from sharding file. Please note restoration time will be slightly increased due to reading from file instead of directly from RestoreArgs. Note also that this option is unsafe when restoring on a different topology than the checkpoint was saved with.
  warnings.warn(</code></pre>
</div>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> partial</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> physmodjax.utils.metrics <span class="im">import</span> (</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    mse,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    mae,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    mse_relative,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    mae_relative,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    accumulate_metrics,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">@partial</span>(jax.jit, static_argnames<span class="op">=</span>(<span class="st">"model"</span>, <span class="st">"norm"</span>))</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> val_step(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    state: train_state.TrainState,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    x,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    y,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    norm,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> norm <span class="kw">in</span> [<span class="st">"batch"</span>]:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> model.<span class="bu">apply</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>            {<span class="st">"params"</span>: state.params, <span class="st">"batch_stats"</span>: state.batch_stats}, x</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        pred <span class="op">=</span> model.<span class="bu">apply</span>({<span class="st">"params"</span>: state.params}, x)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"val/mse"</span>: mse(y, pred),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"val/mae"</span>: mae(y, pred),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"val/mse_rel"</span>: mse_relative(y, pred),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"val/mae_rel"</span>: mae_relative(y, pred),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics, pred</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>val_batch_metrics <span class="op">=</span> []</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, y <span class="kw">in</span> val_dataloader:</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    metrics, pred <span class="op">=</span> val_step(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        state,</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span>x,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span>y,</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        norm<span class="op">=</span>cfg.model.norm,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    val_batch_metrics.append(metrics)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>val_batch_metrics <span class="op">=</span> accumulate_metrics(val_batch_metrics)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> ckpt_manager.metrics(ckpt_manager.best_step())</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>val_metrics <span class="op">=</span> {k: v <span class="cf">for</span> k, v <span class="kw">in</span> metrics.items() <span class="cf">if</span> <span class="st">"val"</span> <span class="kw">in</span> k}</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> key, value <span class="kw">in</span> val_metrics.items():</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> np.isclose(</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>        value, val_batch_metrics[key], atol<span class="op">=</span><span class="fl">1e-6</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    ), <span class="ss">f"Metric </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss"> does not match: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss"> != </span><span class="sc">{</span>val_batch_metrics[key]<span class="sc">}</span><span class="ss">"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/rodrigodzf\.github\.io\/physmodjax");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/rodrigodzf/physmodjax/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>